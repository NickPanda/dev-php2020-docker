# Unit-тестирование

Задание: https://drive.google.com/file/d/1yAtmj9DE2yFeGh26WxDwr42j7RVbB_PI/view

## Вводные данные (поля):

- card_number (номер карты, 16 цифр);
- card_holder (имя и фамилия владельца латиницей + дефис);
- card_expiration (месяц/год окончания действия карты в формате мм/гг);
- cvv (код с обратной стороны карты, 3 цифры);
- order_number (номер заказа, до 16 произвольных символов);
- sum (сумма оплаты, разделитель дробной и целой части запятая).

## Модульные тесты

### Валидация поля card_number
- Если поле card_number пустое, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле card_number не подходит под след. шаблон регулярного выражения `^[\d]{16}$` (поле не содержит 16 цифр), то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
    - этот кейс покроет и случаи с пробелами в начале и в конце, а также пробелы между цифрами, но чтобы пользователя не напрягать ошибками из-за пробелов, то до валидации очистить все пробелы

### Валидация поля card_holder
- Если поле card_holder пустое, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле card_holder содержит недопустимые символы, кроме дефиса и букв прописной латиницы, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле card_holder содержит меньше 2 букв прописной латиницы (одна для имени, одна для фамилии) и нет пробела, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле card_holder содержит пробелы в начале, в конце и более двух пробелов в середине, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
    - чтобы пользователя не напрягать ошибками из-за пробелов, то до валидации очистить все лишние пробелы.
    - также для удобства независимо от раскладки и регистра вводить прописной латиницей

### Валидация поля card_expiration
- Если поле card_expiration пустое, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле card_expiration не подходит под след. шаблон регулярного выражения `^[\d]{2}\/[\d]{4}$` (поле не подходит под формат `XX/XXXX`, где X - цифра), то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле card_expiration содержит значение прошлого (карта считается просроченной), то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
    - Либо разбить проверку на несколько методов проверяя по отдельности связку месяц+год и если год и(или) месяц меньше текущей даты, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;

### Валидация поля cvv
- Если поле cvv пустое, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле cvv не подходит под след. шаблон регулярного выражения `^[\d]{3}$` (поле не содержит 3 цифр), то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;

### Валидация поля order_number
- Если поле order_number пустое, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле order_number не подходит под след. шаблон регулярного выражения `^.{1,16}$` (поле не содержит от 1 до 16 символов), то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;

### Валидация поля sum
- Если поле sum пустое, то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле sum не подходит под след. шаблон регулярного выражения `^([\d]+,[\d]+)$` (поле не подходит под формат `XX,XX`, где X - цифра), то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;
- Если поле sum равно 00,00 (т.е. целая и дробная часть равна 0), то тестируемый метод возвращает HTTP-код 400 с сообщением об ошибке;

**если все поля корретны, то метод контроллера передаёт их в API-запросе на сервис A и не возвращается HTTP-код 400**

## Интеграционные тесты

- Проверяем связку **фронт-бэк** (_бэк валидирует данные_):
    - Если на бэк отправлено невалидное значение поля `card_number`, то после ответа от бэка на фронте поле `Номер карты` будет выделено красной рамкой и будет выведен текст ошибки;
    - Если на бэк отправлено невалидное значение поля `card_holder`, то после ответа от бэка на фронте поле `Имя и фамилия владельца` будет выделено красной рамкой и будет выведен текст ошибки;
    - Если на бэк отправлено невалидное значение поля `card_expiration`, то после ответа от бэка на фронте поле `Месяц/год окончания действия карты` будет выделено красной рамкой и будет выведен текст ошибки;
    - Если на бэк отправлено невалидное значение поля `cvv`, то после ответа от бэка на фронте поле `CVV код` будет выделено красной рамкой и будет выведен текст ошибки;
    - Если на бэк отправлено невалидное значение поля `order_number`, то после ответа от бэка на фронте поле `Номер заказа` будет выделено красной рамкой и будет выведен текст ошибки;
    - Если на бэк отправлено невалидное значение поля `sum`, то после ответа от бэка на фронте поле `Сумма оплаты` будет выделено красной рамкой и будет выведен текст ошибки;

- Проверяем связку **бэк-сервис А** (_после валидации данные отправляются в сервис А. Сервис A пытается списать деньги_):
    - если списание прошло успешно, то возвращается HTTP-код 200
    - если списание не удалось, то возвращается HTTP-код 403

- Проверяем связку **бэк-репозиторий** (_после отправки в сервис А вызвается метод `setOrderIsPaid(string $orderNumber, float $sum): bool{}` для записи информации об успешной оплате. в БД_):
    - если значение аргумента `$orderNumber` невалидное (номер заказа не соответствует изначальному значению), то метод выбрасывает исключение `OrderIsPaidArgumentException`
    - если значение аргумента `$sum` невалидное (сумма оплаты не соответствует изначальному значению), то метод выбрасывает исключение `OrderIsPaidArgumentException`
    - если значения аргументов (`$orderNumber`, `$sum`) валидные, то метод вернет `true` 

## Системные тесты:

- Если одно из переданных с фронта полей (card_number, card_holder, card_expiration, cvv) неверное, то после получения ответа от бэка на фронте выводится сообщение об ошибке **Не удалось провести оплату, проверьте реквизиты карты** и поля с неверными данными выделяются красной рамкой;
- Если все поля заполнены верными данными, но на карте недостаточно средств (сервис А вернет HTTP-код 403), то после получения ответа от бэка на фронте выводится сообщение об ошибке **Не удалось провести оплату, на карте недостаточно средств**
- Если все поля заполнены верными данными, сервис А успешно провел платежу (HTTP-код 200), но при записи в БД возникла ошибка (выброшено исключение OrderIsPaidArgumentException), то после получения ответа от бэка на фронте выводится сообщение об ошибке **Не удалось провести оплату. Ошибка сервера, повторите позднее**
- Если все поля заполнены верными данными, сервис А провел успешно оплату и успешна прошла запись в БД, то после получения ответа от бэка на фронте выводится сообщение **Платеж прошел успешно**.

## Удешевление тестов сервиса А

В случае  негативных тестов реальных денежных затрат не будет, значит требуется удешевлять только позитивные, которые ведут к списанию реальных денежных средств.
Чтобы при тестирование сервиса А было меньше реальных денежных затрат, то для позитивных тестов:
- можно использовать тестовые данные, при которых сервис А будет эмулировать положительный ответ
- можно написать эмулятор сервиса А, чтобы проверять работу кода, а на реальном тестировать финально и на небольшие суммы
